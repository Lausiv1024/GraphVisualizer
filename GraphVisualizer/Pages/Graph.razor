@page "/graph"
@using GraphLibrary
@inject IJSRuntime JSRuntime
<div class="control-header">
    <h1 style="font-size:32px">GraphVisualizer</h1>
    <button class="btn btn-success">実行</button>
    <div style=" align-items: center;">
        <InputCheckbox id="check1" @bind-Value="isAutoRunning"></InputCheckbox>
        <label for="check1">自動で実行</label>
    </div>
    
    <div class="input-group interval-number">
        <span class="input-group-text">実行間隔</span>
        <input class="form-control" type="number">
    </div>
</div>
<div class="base">


    <div class="controller lritem">

        <button @onclick="click"></button>
        <div class="border-radius5">
            <p>node</p>
            <div class="nodes list-group">
                @foreach (var node in Nodes)
                {
                    if (SelectedNode == node)
                    {
                        <button type="button" class="list-group-item list-group-item-action active">@(node.id + ":" + node.title)</button>

                    }
                    else
                    {
                        <button type="button" @onclick="()=>SelectNode(node)" class="list-group-item list-group-item-action">@(node.id + ":" + node.title)</button>

                    }
                }

            </div>
            @if(SelectedNode != null)
            {

                <div class="remove">
                    <span>nodeの削除</span>
                    <button class="button-right btn btn-danger" @onclick="clickNodeDelete">nodeの削除</button>

                </div>
                <div class="edit">
                    <p>選択中nodeの編集</p>
                    <div class="input-group mb-3">
                        <span class="input-group-text">nodeのタイトル</span>
                        <input type="text" class="form-control" @bind = "editNodeTitle">
                    </div>
                    <button class="button-right btn btn-primary" @onclick="clickNodeEdit">nodeの編集</button>
                </div>
            }


            <div class="create">
                <p>nodeの追加</p>
                <div class="input-group mb-3">
                    <span class="input-group-text">ID</span>
                    <input type="text" class="form-control" @bind="createNodeId">
                </div>
                <div class="input-group mb-3">
                    <span class="input-group-text">nodeのタイトル</span>
                    <input type="text" class="form-control" @bind="createNodeTitle">
                </div>
                <button class="button-right btn btn-primary" @onclick="clickNodeCreate">nodeの追加</button>
                <p style="color:red">@warningCreateNode</p>

            </div>
        </div>
        @if (SelectedNode != null)
        {
            <div class="border-radius5">
                <p>edge</p>
                <div class="edges list-group">

                        @foreach (var edge in SelectedNode.ToEdges)
                        {
                            if (SelectedToEdge != null&&SelectedToEdge.ID == edge.ID)
                            {
                                <button type="button" class="list-group-item list-group-item-action active">@($"({SelectedNode.id}:{SelectedNode.title}) - ({edge.ToNode.id}:{edge.ToNode.title})")</button>

                            }
                            else
                            {
                                <button type="button" @onclick="()=>SelectToEdge(edge)" class="list-group-item list-group-item-action">@($"({SelectedNode.id}:{SelectedNode.title}) - ({edge.ToNode.id}:{edge.ToNode.title})")</button>

                            }
                        }
                
                </div>
                @if (SelectedToEdge != null)
                {
                    <div class="remove">
                        <span>edgeの削除</span>
                        <button class="button-right btn btn-danger" @onclick="clickEdgeDelete">edgeを削除</button>

                    </div>
                
                <div class="edit">

                    <p>edgeの編集</p>
                    <div class="input-group mb-3">
                        <span class="input-group-text">edgeの重み</span>
                        <input class="form-control" type="number" @bind="editEdgeWeighInput">
                    </div>

                    <div class="input-group mb-3">
                        <span class="input-group-text">接続先のnode</span>
                        <select @bind="EditToEdgeNodeSelected" class="form-select" aria-label="Default select example">
                            @if (EditToEdgeNodeSelected == null)
                            {
                                <option value="@("")" selected>nodeの選択</option>

                            }
                            else
                            {
                                <option value="@("")">nodeの選択</option>

                            }
                            @foreach (var nodeSelect in Nodes)
                            {
                                @if (EditToEdgeNodeSelected == nodeSelect.id)
                                {
                                    <option value="@nodeSelect.id" selected>@($"{nodeSelect.id}:{nodeSelect.title}")</option>

                                }
                                else
                                {

                                    <option value="@nodeSelect.id">@($"{nodeSelect.id}:{nodeSelect.title}")</option>


                                }


                            }

                        </select>
                    </div>

                    <button class="button-right btn btn-primary" @onclick="clickEdgeEdit">edgeを編集</button>
                    <p style="color:red">@editEdgeWarning</p>


                </div>

                }
                <div class="create">
                    <p>edgeを追加</p>
                    <div class="input-group mb-3">
                        <span class="input-group-text">edgeの重み</span>
                        <input type="number" class="form-control" @bind="createEdgeWeighInput">
                    </div>

                    <div class="input-group mb-3">
                        <span class="input-group-text">接続先のnode</span>
                        <select @bind="CreateToEdgeNodeSelected" class="form-select" aria-label="Default select example">
                            @if (CreateToEdgeNodeSelected == null || CreateToEdgeNodeSelected == "")
                            {
                                <option value="@("")" selected>nodeの選択</option>

                            }
                            else
                            {
                                <option value="@("")">nodeの選択</option>

                            }
                            @foreach (var nodeSelect in Nodes)
                            {
                                @if (CreateToEdgeNodeSelected == nodeSelect.id)
                                {
                                    <option value="@nodeSelect.id" selected>@($"{nodeSelect.id}:{nodeSelect.title}")</option>

                                }
                                else
                                {

                                    <option value="@nodeSelect.id">@($"{nodeSelect.id}:{nodeSelect.title}")</option>


                                }


                            }

                        </select>
                    </div>

                    <button class="button-right btn btn-primary" @onclick = "clickEdgeCreate">edgeを追加</button>
                    <p style="color:red">@createEdgeWarning</p>


                </div>
            </div>

        }

    </div>
    <div id="cy" class="center-item"></div>
    <div class="code-base">
        <p>C#のコード</p>
        <button class="btn btn-success">実行</button>
        <textarea class="form-control">

        </textarea> 
    </div>
</div>


<style>
    .base{
        display:flex;
        justify-items:stretch;
        justify-content: space-between;
        height:calc(100vh - 50px);
    }


    
    .control-header{
        height:50px;
        background-color:darkgray;
        display:flex;
        justify-content:flex-start;
        gap:20px;
        flex-wrap:wrap;
        text-align:center;
        padding:5px 20px;
        box-sizing:border-box;
    }
    @@media screen and  (max-width:1024px) {
        .base{
            height:calc(100vh - 130px);

        }
        .control-header{
            height:130px;

        }
    }
    .interval-number{
        width:200px
    }
    .controller{
        background-color:lightgray;
        padding:10px;
        overflow: auto;
        overflow-y: scroll;
        width: 400px;
    }

    .center-item {
        flex-grow: 1;
    }

    .lritem {
    }

    .edge{
        height:400px;
    }
    .nodes{
        max-height:200px;
        overflow: auto;
        overflow-y: scroll;
    }

    .edges {
        max-height: 200px;
        overflow: auto;
        overflow-y: scroll;
    }

    .remove {
        background-color: #f3f3f3;
        margin: 5px;
        border-radius: 5px;
        padding: 10px;
    }
    .edit {
        background-color: #f3f3f3;
        margin:5px;
        border-radius: 5px;
        padding: 10px;
    }
    .border-radius5{
        border-radius: 5px;
        border: 1px solid gray;
        padding: 10px;
        margin-bottom: 30px;
    }
    .create{
        background-color: #f3f3f3;
        padding:10px;
        margin: 5px;
        border-radius: 5px;
    }

    .button-right{
        display: block;
        margin-left: auto;
        margin-right:0;
    }

    .code-base{
        width:500px;
    }
    .code-area{
        width:100%;
    }
</style>
@code {
    string createEdgeWarning = "";
    string createEdgeWeighInput ="-1";
    string CreateToEdgeNodeSelected;
    string EditToEdgeNodeSelected;
    string editEdgeWeighInput = "-1";
    List<Node> Nodes = new List<Node>();
    ToEdge SelectedToEdge;
    Node SelectedNode;
    string editEdgeWarning = "";
    bool IsInitialized = false;
    string createNodeTitle = "";
    string createNodeId = "";
    string editNodeTitle = "";
    string warningCreateNode = "";
    bool _isAutoRunning;
    bool isAutoRunning
    {
        get
        {
            return _isAutoRunning;
        }
        set
        {
            _isAutoRunning = value;
        }
    }

    void clickNodeDelete()
    {
        SelectedNode.Delete();
    }
    void clickNodeCreate()
    {
        if(Nodes.Where(x=>x.id == createNodeId).Count() > 0)
        {
            warningCreateNode = "存在するIDです。";

            return;
        }
        Node.Create(createNodeId, createNodeTitle);
        createNodeId = "";
        createNodeTitle = "";
    }
    void clickNodeEdit()
    {
        SelectedNode.title = editNodeTitle;
    }
    void SelectToEdge(ToEdge toEdge)
    {
        
        SelectedToEdge = toEdge;
        editEdgeWeighInput = toEdge.Weight.ToString();
        EditToEdgeNodeSelected = toEdge.ToNode.id;
        StateHasChanged();
    }

    void clickEdgeCreate()
    {
        int weight = 0;
        if (!int.TryParse(createEdgeWeighInput,out weight))
        {
            createEdgeWarning = "edgeの重みは数値にしてください";
            StateHasChanged();

            return;
        }
        var targetNode = Nodes.Where(x => x.id == CreateToEdgeNodeSelected).FirstOrDefault();
        if(targetNode == default(Node))
        {
            if (CreateToEdgeNodeSelected == null || CreateToEdgeNodeSelected == "")
            {
                createEdgeWarning = "nodeを選択してください";

            }
            else
            {
                createEdgeWarning = "削除されたnodeです";

            }

            return;
        }
        SelectedNode.NewToEdge(targetNode, weight);
        StateHasChanged();
    }
    void clickEdgeDelete()
    {
        if(SelectedToEdge != null)
        {
            SelectedToEdge.Delete();
        }
    }
    void clickEdgeEdit()
    {
        int weight = 0;
        if (!int.TryParse(editEdgeWeighInput, out weight))
        {
            editEdgeWarning = "edgeの重みは数値にしてください";
            return;
        }
        var targetNode = Nodes.Where(x => x.id == EditToEdgeNodeSelected).FirstOrDefault();
        if (targetNode == default(Node))
        {
            if(EditToEdgeNodeSelected == null||EditToEdgeNodeSelected == "")
            {
                editEdgeWarning = "nodeを選択してください";

            }
            else
            {
                editEdgeWarning = "削除されたnodeです";

            }
            return;
        }
        SelectedToEdge.ToNode = targetNode;
        SelectedToEdge.Weight = weight;
        StateHasChanged();
    }
    void SelectNode(Node node)
    {
        if (node == SelectedNode)
        {
            return;
        }
        SelectedNode = node;
        SelectedToEdge = null;
        createEdgeWeighInput = "-1";
        CreateToEdgeNodeSelected = "";
        editNodeTitle = node.title;

    }
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            IsInitialized = false;



            var node0 =  Node.Create("0", "gray", "0");
            var node1 = Node.Create("1", "gray", "1");
            var node2 = Node.Create("2", "gray", "2");
            var node3 = Node.Create("3", "gray", "3");
            var node4 = Node.Create("4", "gray", "4");
            var node5 = Node.Create("5", "gray", "5");
            var node6 = Node.Create("6", "gray", "6");
            var node7 = Node.Create("7", "gray", "7");
            node0.NewToEdge(node1,-1);
            node0.NewToEdge(node2,-1);
            node2.NewToEdge(node3,-1);
            node3.NewToEdge(node0, -1);
            node3.NewToEdge(node4, -1);
            node4.NewToEdge(node5, -1);
            node3.NewToEdge(node6, -1);
            node6.NewToEdge(node1, -1);
            node2.NewToEdge(node7, -1);

            EdgeAndNode en = new EdgeAndNode();
            Nodes = Node.Nodes.ToList();

            en.Nodes = Nodes.Select(x => new InNodeObject { data = x.ToInternalNode() }).ToList();
            en.Edges = Node.Edges.Select(x => new InEdgeObject { data = x.ToInternalEdge() }).ToList();
            await JSRuntime.InvokeVoidAsync("drawGraph", "cy",en);
            Node.ColorChange = NodeColorChange;
            Node.CreateNode = CreateNode;
            Node.DeleteNode = DeleteNode;
            ToEdge.ColorChange = EdgeColorChange;
            ToEdge.DeleteChange = EdgeDelete;
            ToEdge.WeightChange = WeightChange;
            ToEdge.ToNodeChange = ToNodeChange;
            Node.CreateEdge= CreateEdge;
            Node.TitleChange = NodeTitleChange;
            StateHasChanged();
        }

    }
    bool tmp = false;


    async Task click()
    {
        // await JSRuntime.InvokeVoidAsync("changeNodeColor", "a", "black");
        // await JSRuntime.InvokeVoidAsync("changeEdgeColor", "ab", "orange");
        // await JSRuntime.InvokeVoidAsync("changeEdgeSource", "ab", "t12");
        // await JSRuntime.InvokeVoidAsync("drawGraph", "cy");

        //await JSRuntime.InvokeVoidAsync("isDirected", tmp);
        var node =  Node.Create("a", "blue", "abc");
        node.NewToEdge(node,10);
        var edges = node.ToEdges;
        var d = edges.First().ToInternalEdge();

        d.source = "t12";
        d.color = "blue";
        d.id = "ab";
        await JSRuntime.InvokeVoidAsync("updateNode", d);
        tmp = !tmp;
    }
    async void NodeTitleChange(Node node)
    {
        await JSRuntime.InvokeVoidAsync("updateNode", node.ToInternalNode());

    }
    async void EdgeColorChange(Edge edge)
    {
        await JSRuntime.InvokeVoidAsync("updateEdge", edge.ToInternalEdge());
    }
    async void WeightChange(Edge edge)
    {
        await JSRuntime.InvokeVoidAsync("updateEdge", edge.ToInternalEdge());

    }
    async void EdgeDelete(Edge edge)
    {
        if(SelectedNode.ToEdges.Where(x=>x.ID == edge.ID).Count() > 0)
        {
            if(SelectedToEdge.ID == edge.ID)
            {
                SelectedToEdge = null;
            } 
            StateHasChanged();
        }
        await JSRuntime.InvokeVoidAsync("removeAtId", edge.ID);
    }
    async void EdgeWeightChange(Edge edge)
    {
        await JSRuntime.InvokeVoidAsync("updateEdge", edge.ToInternalEdge());

    }
    async void ToNodeChange(Edge edge)
    {
        await JSRuntime.InvokeVoidAsync("updateEdge", edge.ToInternalEdge());

    }

    async void NodeColorChange(Node node)
    {
        await JSRuntime.InvokeVoidAsync("updateNode", node.ToInternalNode());

    }

    async void CreateNode(Node node)
    {
        Nodes = Node.Nodes.ToList();
        await JSRuntime.InvokeVoidAsync("nodeAdd", node.ToInternalNode());

        StateHasChanged();
    }

    async void CreateEdge(Edge edge)
    {
        Nodes = Node.Nodes.ToList();
        await JSRuntime.InvokeVoidAsync("edgeAdd", edge.ToInternalEdge());
        StateHasChanged();
    }
    async void DeleteNode(Node node)
    {

        Nodes = Node.Nodes.ToList();
        if (!Nodes.Contains(SelectedNode))
        {
            SelectedNode = null;
        }
        await JSRuntime.InvokeVoidAsync("removeAtId", node.id);

        StateHasChanged();
    }
}
